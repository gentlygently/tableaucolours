name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.123)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format MAJOR.MINOR.BUILD (e.g., 1.0.123)"
            exit 1
          fi
          echo "Version format validated: ${VERSION}"
      
      - name: Download build metadata
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ci.yml
          name: build-metadata-${{ inputs.version }}
          path: build-metadata/
          search_artifacts: true
      
      - name: Read build metadata
        id: metadata
        run: |
          if [ ! -f "build-metadata/commit_sha.txt" ]; then
            echo "Error: Build metadata not found for version ${{ inputs.version }}"
            echo "Make sure the CI workflow has created this version"
            exit 1
          fi
          COMMIT_SHA=$(cat build-metadata/commit_sha.txt)
          RUN_ID=$(cat build-metadata/run_id.txt)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "Found build for commit: ${COMMIT_SHA} (run: ${RUN_ID})"
      
      - name: Checkout specific commit
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.metadata.outputs.commit_sha }}
          fetch-depth: 0
      
      - name: Download build artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ci.yml
          name: build-${{ inputs.version }}
          path: dist/
          search_artifacts: true
      
      - name: Verify artifact downloaded
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Error: Build artifact for version ${{ inputs.version }} not found or empty"
            exit 1
          fi
          echo "Successfully downloaded build artifact for version ${{ inputs.version }}"
          ls -la dist/
      
      - name: Deploy to GitHub Pages
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone the deployment repository
          git clone https://x-access-token:${DEPLOY_TOKEN}@github.com/gentlygently/gentlygently.github.io.git deploy-repo
          
          cd deploy-repo
          
          # Reset and pull latest
          git reset --hard
          git pull
          
          # Remove all files except .git and react directory
          find . -maxdepth 1 ! -name 'react' ! -name '.git' ! -name '.' ! -name '..' -type f -exec rm -rf {} +
          find . -maxdepth 1 ! -name 'react' ! -name '.git' ! -name '.' ! -name '..' -type d -exec rm -rf {} +
          
          # Copy build artifacts
          cp -R ../dist/. .
          
          # Commit and push
          git add .
          git commit -m "Deploy version ${VERSION}" || echo "No changes to commit"
          git push
          
          cd ..
          rm -rf deploy-repo
          
          echo "Successfully deployed version ${VERSION} to GitHub Pages"
      
      - name: Create release archive
        run: |
          cd dist
          zip -r ../build-${{ inputs.version }}.zip .
          cd ..
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: |
            Release version ${{ inputs.version }}
            
            Built from commit: ${{ steps.metadata.outputs.commit_sha }}
            Deployed to: https://gentlygently.github.io/
          files: build-${{ inputs.version }}.zip
          draft: false
          prerelease: false
          target_commitish: ${{ steps.metadata.outputs.commit_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
