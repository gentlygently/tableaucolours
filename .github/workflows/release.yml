name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.123)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format MAJOR.MINOR.BUILD (e.g., 1.0.123)"
            exit 1
          fi
          echo "Version format validated: ${VERSION}"
      
      - name: Download release artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          # Check if release exists
          if ! gh release view "v${VERSION}" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Error: Release v${VERSION} not found"
            echo "Available releases:"
            gh release list --repo ${{ github.repository }} --limit 10
            exit 1
          fi
          
          # Download the build archive
          echo "Downloading build artifact for version ${VERSION}..."
          gh release download "v${VERSION}" \
            --repo ${{ github.repository }} \
            --pattern "build-${VERSION}.zip"
          
          # Extract the archive
          unzip "build-${VERSION}.zip" -d dist/
          echo "Successfully downloaded and extracted build artifact"
          ls -la dist/
      
      - name: Checkout repository for deployment script
        uses: actions/checkout@v4
      
      - name: Deploy to GitHub Pages
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone the deployment repository
          git clone https://x-access-token:${DEPLOY_TOKEN}@github.com/gentlygently/gentlygently.github.io.git deploy-repo
          
          cd deploy-repo
          
          # Reset and pull latest
          git reset --hard
          git pull
          
          # Remove all files except .git and react directory
          find . -maxdepth 1 ! -name 'react' ! -name '.git' ! -name '.' ! -name '..' -type f -exec rm -rf {} +
          find . -maxdepth 1 ! -name 'react' ! -name '.git' ! -name '.' ! -name '..' -type d -exec rm -rf {} +
          
          # Copy build artifacts
          cp -R ../dist/. .
          
          # Commit and push
          git add .
          git commit -m "Deploy version ${VERSION}" || echo "No changes to commit"
          git push
          
          cd ..
          rm -rf deploy-repo
          
          echo "Successfully deployed version ${VERSION} to GitHub Pages"
      
      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          # Get the original release body
          ORIGINAL_BODY=$(gh release view "v${VERSION}" --json body --jq .body)
          
          # Update release with deployment info
          gh release edit "v${VERSION}" --repo ${{ github.repository }} --notes "$(cat <<EOF
${ORIGINAL_BODY}

---
**Deployment Status:** âœ… Deployed to production
**Deployed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Live URL:** https://gentlygently.github.io/
EOF
)"
          
          echo "Updated release v${VERSION} with deployment information"
